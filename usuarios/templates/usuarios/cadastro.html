{% extends 'usuarios/base.html' %}

{% block title %}Cadastro - Sistema da Igreja{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
    }
    
    .form-section h4 {
        color: #495057;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .required-field > label, .required-field > p {
        font-weight: bold;
    }
    .required-field > label::after, .required-field > p::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
    
    .form-text {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .radio-wrapper {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }

    .filho-form {
        padding: 1rem;
        border: 1px dashed #ced4da;
        border-radius: .5rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-user-plus me-2"></i>
                    Ficha Cadastral de Novo Membro
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Preencha os campos abaixo. Campos marcados com <span class="text-danger">*</span> são obrigatórios.
                    Após o cadastro, aguarde a aprovação de um secretário.
                </p>

                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <div class="form-section">
                        <h4><i class="fas fa-key me-2"></i>Informações de Login</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
                                {{ form.username }}
                                <div class="form-text">Nome que você usará para fazer login.</div>
                                {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                                {{ form.email }}
                                {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.password1.id_for_label }}">{{ form.password1.label }}</label>
                                {{ form.password1 }}
                                {% if form.password1.errors %}<div class="text-danger small">{{ form.password1.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.password2.id_for_label }}">{{ form.password2.label }}</label>
                                {{ form.password2 }}
                                {% if form.password2.errors %}<div class="text-danger small">{{ form.password2.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4><i class="fas fa-user me-2"></i>Dados Pessoais</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.nome_completo.id_for_label }}">{{ form.nome_completo.label }}</label>
                                {{ form.nome_completo }}
                                {% if form.nome_completo.errors %}<div class="text-danger small">{{ form.nome_completo.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.foto_perfil.id_for_label }}">{{ form.foto_perfil.label }}</label>
                                {{ form.foto_perfil }}
                                {% if form.foto_perfil.errors %}<div class="text-danger small">{{ form.foto_perfil.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="{{ form.nome_pai.id_for_label }}">{{ form.nome_pai.label }}</label>{{ form.nome_pai }}</div>
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.nome_mae.id_for_label }}">{{ form.nome_mae.label }}</label>
                                {{ form.nome_mae }}
                                {% if form.nome_mae.errors %}<div class="text-danger small">{{ form.nome_mae.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3 required-field">
                                <label for="{{ form.cpf.id_for_label }}">{{ form.cpf.label }}</label>
                                {{ form.cpf }}
                                {% if form.cpf.errors %}<div class="text-danger small">{{ form.cpf.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.rg.id_for_label }}">{{ form.rg.label }}</label>
                                {{ form.rg }}
                            </div>
                            <div class="col-md-4 mb-3 required-field">
                                <label for="{{ form.data_nascimento.id_for_label }}">{{ form.data_nascimento.label }}</label>
                                {{ form.data_nascimento }}
                                {% if form.data_nascimento.errors %}<div class="text-danger small">{{ form.data_nascimento.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3"><label for="{{ form.naturalidade.id_for_label }}">{{ form.naturalidade.label }}</label>{{ form.naturalidade }}</div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.estado_civil.id_for_label }}">{{ form.estado_civil.label }}</label>
                                {{ form.estado_civil }}
                            </div>
                            <div class="col-md-8">
                                <div id="campos-casado" class="hidden">
                                    <div class="row">
                                        <div class="col-md-7"><label for="{{ form.nome_conjuge.id_for_label }}">{{ form.nome_conjuge.label }}</label>{{ form.nome_conjuge }} {% if form.nome_conjuge.errors %}<div class="text-danger small">{{ form.nome_conjuge.errors.0 }}</div>{% endif %}</div>
                                        <div class="col-md-5"><label for="{{ form.data_casamento.id_for_label }}">{{ form.data_casamento.label }}</label>{{ form.data_casamento }} {% if form.data_casamento.errors %}<div class="text-danger small">{{ form.data_casamento.errors.0 }}</div>{% endif %}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="radio-wrapper mt-3 required-field">
                            <p>{{ form.tem_filhos.label }}</p>
                            <div>
                                {% for radio in form.tem_filhos %}
                                <div class="form-check form-check-inline">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            {% if form.tem_filhos.errors %}<div class="text-danger small">{{ form.tem_filhos.errors.0 }}</div>{% endif %}
                        </div>
                        <div id="secao-filhos" class="mt-3 hidden">
                            <h5><i class="fas fa-children me-2"></i>Filhos</h5>
                            {{ filhos_formset.management_form }}
                            {% if filhos_formset.non_form_errors %}
                                <div class="alert alert-danger">{{ filhos_formset.non_form_errors }}</div>
                            {% endif %}
                            <div id="filhos-forms-container">
                                {% for filho_form in filhos_formset %}
                                    <div class="filho-form">
                                        {{ filho_form.id }}
                                        {% for hidden_field in filho_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                                        
                                        {% for field in filho_form.visible_fields %}
                                            <div class="mb-2">
                                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                {{ field }}
                                                {% if field.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in field.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="add-filho-btn" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="fas fa-plus me-2"></i>Adicionar outro filho
                            </button>
                        </div>
                        <hr>
                        <div class="radio-wrapper mt-3">
                            <p class="fw-bold">{{ form.tem_alergia_medicacao.label }}</p>
                            <div>
                                {% for radio in form.tem_alergia_medicacao %}
                                <div class="form-check form-check-inline">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <div id="campo-alergias" class="mt-2 hidden">
                                <label for="{{ form.alergias_texto.id_for_label }}">{{ form.alergias_texto.label }}</label>
                                {{ form.alergias_texto }}
                                {% if form.alergias_texto.errors %}<div class="text-danger small">{{ form.alergias_texto.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4><i class="fas fa-map-marker-alt me-2"></i>Contato e Endereço</h4>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label for="{{ form.telefone.id_for_label }}">{{ form.telefone.label }}</label>{{ form.telefone }}</div>
                             <div class="col-md-4 mb-3">
                                <label for="{{ form.cep.id_for_label }}">{{ form.cep.label }}</label>
                                {{ form.cep }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3"><label for="{{ form.endereco.id_for_label }}">{{ form.endereco.label }}</label>{{ form.endereco }}</div>
                            <div class="col-md-4 mb-3"><label for="{{ form.bairro.id_for_label }}">{{ form.bairro.label }}</label>{{ form.bairro }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="{{ form.cidade.id_for_label }}">{{ form.cidade.label }}</label>{{ form.cidade }}</div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4><i class="fas fa-briefcase me-2"></i>Profissão e Educação</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="{{ form.profissao.id_for_label }}">{{ form.profissao.label }}</label>{{ form.profissao }}</div>
                            <div class="col-md-6 mb-3"><label for="{{ form.nivel_escolar.id_for_label }}">{{ form.nivel_escolar.label }}</label>{{ form.nivel_escolar }}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-church me-2"></i>Informações Eclesiásticas</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3 required-field">
                                <label for="{{ form.data_conversao.id_for_label }}">{{ form.data_conversao.label }}</label>
                                {{ form.data_conversao }}
                                {% if form.data_conversao.errors %}<div class="text-danger small">{{ form.data_conversao.errors.0 }}</div>{% endif %}
                            </div>
                             <div class="col-md-6 d-flex align-items-center pt-3">
                                <div class="form-check">
                                    {{ form.data_conversao_nao_lembro }}
                                    <label class="form-check-label" for="{{ form.data_conversao_nao_lembro.id_for_label }}"> {{ form.data_conversao_nao_lembro.label }}</label>
                                </div>
                            </div>
                        </div>
                        <div class="checkbox-wrapper mt-3">
                            <div class="form-check">{{ form.batizado_aguas }} <label for="{{ form.batizado_aguas.id_for_label }}" class="form-check-label">{{ form.batizado_aguas.label }}</label></div>
                            <div id="campos-batismo" class="mt-2 ps-3 hidden">
                                <div class="row">
                                    <div class="col-md-6 mb-3"><label for="{{ form.data_batismo.id_for_label }}">{{ form.data_batismo.label }}</label>{{ form.data_batismo }} {% if form.data_batismo.errors %}<div class="text-danger small">{{ form.data_batismo.errors.0 }}</div>{% endif %}</div>
                                    <div class="col-md-6 mb-3"><label for="{{ form.local_batismo.id_for_label }}">{{ form.local_batismo.label }}</label>{{ form.local_batismo }} {% if form.local_batismo.errors %}<div class="text-danger small">{{ form.local_batismo.errors.0 }}</div>{% endif %}</div>
                                </div>
                                <div id="campos-outra-igreja" class="hidden">
                                    <div class="mb-3"><label for="{{ form.outra_igreja_batismo.id_for_label }}">{{ form.outra_igreja_batismo.label }}</label>{{ form.outra_igreja_batismo }} {% if form.outra_igreja_batismo.errors %}<div class="text-danger small">{{ form.outra_igreja_batismo.errors.0 }}</div>{% endif %}</div>
                                    <div class="form-check">{{ form.recebido_por_aclamacao }} <label for="{{ form.recebido_por_aclamacao.id_for_label }}" class="form-check-label">{{ form.recebido_por_aclamacao.label }}</label></div>
                                </div>
                            </div>
                        </div>
                        <div class="checkbox-wrapper mt-3">
                            <div class="form-check">{{ form.membro_congregacao }} <label for="{{ form.membro_congregacao.id_for_label }}" class="form-check-label">{{ form.membro_congregacao.label }}</label></div>
                            <div id="campo-congregacao" class="mt-2 ps-3 hidden">
                                <label for="{{ form.qual_congregacao.id_for_label }}">{{ form.qual_congregacao.label }}</label>
                                {{ form.qual_congregacao }}
                                {% if form.qual_congregacao.errors %}<div class="text-danger small">{{ form.qual_congregacao.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="checkbox-wrapper mt-3">
                            <div class="form-check">{{ form.frequenta_escola_biblica }} <label for="{{ form.frequenta_escola_biblica.id_for_label }}" class="form-check-label">{{ form.frequenta_escola_biblica.label }}</label></div>
                            <div id="campo-escola-biblica" class="mt-2 ps-3 hidden">
                                <label for="{{ form.qual_classe_escola_biblica.id_for_label }}">{{ form.qual_classe_escola_biblica.label }}</label>
                                {{ form.qual_classe_escola_biblica }}
                                {% if form.qual_classe_escola_biblica.errors %}<div class="text-danger small">{{ form.qual_classe_escola_biblica.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="checkbox-wrapper mt-3">
                            <div class="form-check">{{ form.deseja_exercer_funcao }} <label for="{{ form.deseja_exercer_funcao.id_for_label }}" class="form-check-label">{{ form.deseja_exercer_funcao.label }}</label></div>
                            <div id="campo-funcao-desejada" class="mt-2 ps-3 hidden">
                                <label for="{{ form.qual_funcao_deseja.id_for_label }}">{{ form.qual_funcao_deseja.label }}</label>
                                {{ form.qual_funcao_deseja }}
                                {% if form.qual_funcao_deseja.errors %}<div class="text-danger small">{{ form.qual_funcao_deseja.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger mt-3">
                            <p class="fw-bold">Foram encontrados os seguintes erros gerais:</p>
                            {% for error in form.non_field_errors %}
                                <div><i class="fas fa-exclamation-circle me-2"></i>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="d-flex justify-content-between mt-4">
                        <a href="/" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
                        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-user-plus me-2"></i>Cadastrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<template id="filho-form-template">
    {% spaceless %}
    <div class="filho-form">
        {% for field in filhos_formset.empty_form %}
            <div class="mb-2">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
            </div>
        {% endfor %}
    </div>
    {% endspaceless %}
</template>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Função genérica para mostrar/ocultar elementos
    function toggleVisibility(triggerElement, targetElement, showValue) {
        let shouldHide;
        const type = triggerElement.type;

        if (type === 'checkbox') {
            shouldHide = !triggerElement.checked;
        } else if (type === 'radio') {
            const selectedValue = document.querySelector(`input[name="${triggerElement.name}"]:checked`)?.value;
            shouldHide = selectedValue !== showValue;
        } else { // Para Select
            shouldHide = triggerElement.value !== showValue;
        }
        if (targetElement) {
            targetElement.classList.toggle('hidden', shouldHide);
        }
    }

    // Gatilhos e alvos
    const triggers = {
        '#{{ form.estado_civil.id_for_label }}': { target: '#campos-casado', value: 'casado' },
        // --- CORREÇÃO APLICADA AQUI: O valor a ser verificado agora é 'True' (texto), não 'Sim' ---
        'input[name="{{ form.tem_alergia_medicacao.name }}"]': { target: '#campo-alergias', value: 'True' },
        'input[name="{{ form.tem_filhos.name }}"]': { target: '#secao-filhos', value: 'True' },
        // --- Fim da correção ---
        '#{{ form.batizado_aguas.id_for_label }}': { target: '#campos-batismo' },
        '#{{ form.local_batismo.id_for_label }}': { target: '#campos-outra-igreja', value: 'outra' },
        '#{{ form.membro_congregacao.id_for_label }}': { target: '#campo-congregacao' },
        '#{{ form.frequenta_escola_biblica.id_for_label }}': { target: '#campo-escola-biblica' },
        '#{{ form.deseja_exercer_funcao.id_for_label }}': { target: '#campo-funcao-desejada' },
    };

    // Aplica os listeners
    for (const selector in triggers) {
        document.querySelectorAll(selector).forEach(el => {
            const config = triggers[selector];
            const target = document.querySelector(config.target);
            el.addEventListener('change', () => toggleVisibility(el, target, config.value));
            toggleVisibility(el, target, config.value); // Executa na inicialização
        });
    }

    // Lógica para adicionar formulários de filhos
    const addFilhoBtn = document.getElementById('add-filho-btn');
    const container = document.getElementById('filhos-forms-container');
    const template = document.getElementById('filho-form-template');
    const totalFormsInput = document.querySelector('[name="filhos-TOTAL_FORMS"]');

    addFilhoBtn.addEventListener('click', function() {
        let formIdx = parseInt(totalFormsInput.value);
        const newFormHtml = template.innerHTML.replace(/__prefix__/g, formIdx);
        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = formIdx + 1;
    });

    // Lógica para Data de Conversão
    const dataConversaoInput = document.getElementById('{{ form.data_conversao.id_for_label }}');
    const naoLembroCheckbox = document.getElementById('{{ form.data_conversao_nao_lembro.id_for_label }}');
    if(dataConversaoInput && naoLembroCheckbox) {
        naoLembroCheckbox.addEventListener('change', function() {
            dataConversaoInput.disabled = this.checked;
            if(this.checked) {
                dataConversaoInput.value = '';
            }
        });
        if(naoLembroCheckbox.checked) dataConversaoInput.disabled = true;
    }

    // Função genérica para aplicar máscara
    function applyMask(input, maskFunction) {
        if(input) {
            input.addEventListener('input', (e) => {
                e.target.value = maskFunction(e.target.value);
            });
        }
    }

    // Funções de máscara
    const maskCPF = (value) => value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    const maskCEP = (value) => value.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').replace(/(-\d{3})\d+?$/, '$1');
    const maskPhone = (value) => value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').replace(/(-\d{4})\d+?$/, '$1');
    const maskRG = (value) => {
        return value
            .replace(/\D/g, '') // Remove tudo que não é dígito
            .replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); // Adiciona ponto como separador de milhar
    };

    // Aplica as máscaras
    applyMask(document.getElementById('{{ form.cpf.id_for_label }}'), maskCPF);
    applyMask(document.getElementById('{{ form.cep.id_for_label }}'), maskCEP);
    applyMask(document.getElementById('{{ form.telefone.id_for_label }}'), maskPhone);
    applyMask(document.getElementById('{{ form.rg.id_for_label }}'), maskRG);
});
</script>
{% endblock %}